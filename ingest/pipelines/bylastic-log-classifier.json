[
  {
    "script": {
      "lang": "painless",
      "source": "String idx = ctx._index != null ? ctx._index.toLowerCase() : null;\r if (idx == null) return;\r \r // Chỉ xử lý các index ưu tiên\r boolean hit = (\r     idx.contains('wazuh') ||\r     idx.contains('zeek') ||\r     idx.contains('suricata') ||\r     idx.contains('pfsense') ||\r     idx.contains('modsecurity') ||\r     idx.contains('apache') ||\r     idx.contains('nginx') ||\r     idx.contains('mysql') ||\r     idx.contains('windows')\r );\r \r if (!hit) return;\r \r // ========================= SURICATA =========================\r if (idx.contains('suricata')) {\r     String eventType = ctx.suricata?.eve?.event_type;\r \r     // Bỏ qua các event không quan trọng\r     if (\r         eventType == null ||\r         eventType == 'stats' ||\r         eventType == 'flow' ||\r         eventType == 'netflow' ||\r         eventType == 'fileinfo' ||\r         eventType == 'dns'\r     ) {\r         return;\r     }\r \r     // Suricata alert\r     if (eventType == 'alert' && ctx.rule?.name != null) {\r         ctx.ml_input =\r             'Suricata Alert: ' + ctx.rule.name +\r             ' | Category: ' + (ctx.rule?.category ?: 'Unknown') +\r             ' | ' + (ctx.source?.ip ?: '-') +\r             ' -> ' + (ctx.destination?.ip ?: '-');\r     }\r \r     return;\r }\r \r // ========================= ZEEK =========================\r if (idx.contains('zeek')) {\r \r     // Only accept real alerts: must have event.kind = \"alert\"\r     String kind = ctx.event?.kind;\r     if (kind == null || kind != 'alert') return;\r \r     // Must have a Zeek notice (we ignore all non-notice datasets)\r     if (ctx.zeek?.notice == null) return;\r \r     // Must have both name + description (alert-level messages)\r     if (ctx.rule?.name != null && ctx.rule?.description != null) {\r         ctx.ml_input =\r             'Zeek Alert: ' + ctx.rule.name +\r             ' | Description: ' + ctx.rule.description +\r             ' | Peer: ' + (ctx.zeek.notice.peer_descr ?: '-');\r         return;\r     }\r \r     // Fallback: use Zeek Notice message only when it's alert-level\r     if (ctx.zeek.notice.msg != null) {\r         ctx.ml_input = 'Zeek Notice: ' + ctx.zeek.notice.msg;\r         return;\r     }\r \r     return;\r }\r \r // ========================= PFSENSE =========================\r if (idx.contains('pfsense')) {\r \r     // Normalize action safely\r     String action = ctx.event?.action != null ? ctx.event.action.toLowerCase() : null;\r     if (action == null) return;\r \r     // Only accept block / reject\r     if (!(action == \"block\" || action == \"reject\")) return;\r \r     // Build ML input safely\r     ctx.ml_input =\r         \"pfSense: \" + action.toUpperCase() + \" \" +\r         (ctx.source?.ip ?: \"-\") + \":\" + (ctx.source?.port ?: \"-\") +\r         \" -> \" +\r         (ctx.destination?.ip ?: \"-\") + \":\" + (ctx.destination?.port ?: \"-\") +\r         \" | Proto: \" + (ctx.network?.transport ?: \"-\");\r \r     return;\r }\r \r // ========================= WAZUH =========================\r if (ctx.rule?.description != null && ctx.full_log != null) {\r     ctx.ml_input = 'Alert: ' + ctx.rule.description + ' | Log: ' + ctx.full_log;\r     return;\r }\r \r // ========================= APACHE =========================\r if (idx.contains('apache')) {\r \r     String level = ctx.log?.level;\r     String msg = ctx.message;\r \r     // Only keep real errors or alerts\r     boolean isAlert =\r         (level != null && (\r             level == 'error' ||\r             level == 'crit' ||\r             level == 'alert' ||\r             level == 'emerg' ||\r             level == 'warning'\r         )) ||\r         (msg != null && (\r             msg.toLowerCase().contains(\"error\") ||\r             msg.toLowerCase().contains(\"failed\") ||\r             msg.toLowerCase().contains(\"attack\") ||\r             msg.toLowerCase().contains(\"denied\") ||\r             msg.toLowerCase().contains(\"modsecurity\")\r         ));\r \r     if (!isAlert) return; // skip normal apache logs\r \r     ctx.ml_input =\r         \"Apache Alert: \" + (msg ?: \"-\") +\r         \" | Level: \" + (level ?: \"-\") +\r         \" | Host: \" + (ctx.host?.hostname ?: \"-\");\r \r     return;\r }\r \r // ========================= MYSQL =========================\r if (idx.contains('mysql')) {\r     String msg = ctx.message;\r     String level = ctx.log?.level;\r \r     // Only process MySQL warnings\r     if (level == null || level != 'Warning') return;\r \r     ctx.ml_input =\r         \"MySQL Warning: \" + (ctx.message ?: \"-\") +\r         \" | Level: \" + level;\r \r     return;\r }\r \r \r // ========================= NGINX =========================\r if (idx.contains(\"nginx\")) {\r \r     String level = ctx.log?.level ?: \"\";\r     String msg = ctx.message ?: \"\";\r \r     // Skip everything if level = notice (too noisy)\r     if (level == \"notice\") return;\r \r     // Skip startup/version messages\r     if (\r         msg.contains(\"version\") ||\r         msg.contains(\"loaded\") ||\r         msg.contains(\"built\") ||\r         msg.contains(\"using\")\r     ) return;\r \r     // If got here → it's a real error\r     ctx.ml_input =\r         \"Nginx Error: \" + msg +\r         \" | Level: \" + level;\r \r     return;\r }\r \r \r \r // ========================= FIREWALL KHÁC =========================\r if (ctx.observer?.type == 'firewall' && ctx.event?.action != null) {\r     ctx.ml_input =\r         'Firewall ' + ctx.event.action + ': ' +\r         (ctx.source?.ip ?: '-') + ':' + (ctx.source?.port ?: '-') +\r         ' -> ' +\r         (ctx.destination?.ip ?: '-') + ':' + (ctx.destination?.port ?: '-');\r     return;\r }\r \r // ========================= WINDOWS =========================\r if (idx.contains('windows')) {\r \r     // Only keep security alerts\r     String level = ctx.log?.level;\r     String kind = ctx.event?.kind;\r     String action = ctx.event?.action;\r     String msg = ctx.message;\r \r     // 1. Must be alert-level or contain detection keywords\r     boolean isAlert =\r         (kind != null && kind == 'alert') ||\r         (level != null && (level == 'warning' || level == 'error' || level == 'critical')) ||\r         (msg != null && (\r             msg.contains('detect') ||\r             msg.contains('malware') ||\r             msg.contains('threat') ||\r             msg.contains('blocked') ||\r             msg.contains('quarantine') ||\r             msg.contains('virus')\r         )) ||\r         (action != null && (\r             action.contains('Detected') ||\r             action.contains('Blocked') ||\r             action.contains('Quarantined')\r         ));\r \r     if (!isAlert) {\r         // skip noisy Windows logs\r         return;\r     }\r \r     // Build ML input\r     ctx.ml_input =\r         'Windows Alert: ' +\r         (ctx.event?.code ?: '-') +\r         ' | Provider: ' + (ctx.event?.provider ?: '-') +\r         ' | Message: ' + (msg ?: '-');\r \r     return;\r }\r \r // ========================= MODSECURITY =========================\r if (idx.contains('modsecurity')) {\r \r     // must have ModSecurity messages (real alerts)\r     if (ctx.modsec?.audit?.messages == null || ctx.modsec.audit.messages.size() == 0) return;\r \r     // must have a query string, otherwise skip (not an attack payload)\r     String query = ctx.url?.query;\r     if (query == null || query.trim().length() == 0) return;\r \r     // build message list\r     String msgs = String.join(\"; \", ctx.modsec.audit.messages);\r \r     ctx.ml_input =\r         \"ModSecurity Alert: \" + msgs +\r         \" | URL: \" + (ctx.url?.original ?: \"-\") +\r         \" | Query: \" + query +\r         \" | SourceIP: \" + (ctx.source?.ip ?: \"-\") +\r         \" | SourcePort: \" + (ctx.source?.port ?: \"-\");\r \r     return;\r }\r \r // Generic fallback: use original event/message if nothing matched\r if (ctx.event?.original != null || ctx.message != null) {\r     ctx.ml_input = ctx.event?.original ?: ctx.message;\r }",
      "ignore_failure": true,
      "description": "Check if should process and build text"
    }
  },
  {
    "inference": {
      "model_id": "byviz__bylastic_classification_logs",
      "target_field": "ml.prediction",
      "field_map": {
        "ml_input": "text_field"
      },
      "inference_config": {
        "text_classification": {
          "num_top_classes": 1
        }
      },
      "if": "ctx.ml_input != null && ctx.ml_input instanceof String && ctx.ml_input.length() > 0 && ctx.ml_input.length() <= 5000",
      "on_failure": [
        {
          "append": {
            "field": "tags",
            "value": [
              "_ml_inference_failure"
            ],
            "allow_duplicates": false
          }
        }
      ]
    }
  }
]